@page "/admin/application-user-list"
@rendermode InteractiveServer
@inject IApplicationUserAdminRepository ApplicationUserAdminRepository
@inject AuthenticationStateProvider GetAuthenticationStateAsync
@attribute [Authorize(Roles = "Admin")]
@attribute [StreamRendering]

<PageTitle>Application User List</PageTitle>

<section>
  <h1>Application User List</h1>
  <article>
    <table class="table table-striped table-sm">
      <thead>
        <tr>
          <th scope="col">ApplicationRoles</th>
          <th scope="col">Email</th>
          <th scope="col">Id</th>
          <th scope="col">PhoneNumber</th>
          <th scope="col">UserName</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        @if (applicationUserAdminDtos == null)
        {
          <tr>
            <td colspan="6">Loading...</td>
          </tr>
        }
        else if (applicationUserAdminDtos.Count == 0)
        {
          <tr>
            <td colspan="6">No application users found.</td>
          </tr>
        }
        else
        {
          @foreach (var applicationUserAdminDto in applicationUserAdminDtos)
          {
            <tr>
              @if (applicationUserAdminDto == null)
              {
                <td colspan="6">Application user is null.</td>
              }
              else
              {
                <td>
                  @if (applicationUserAdminDto.ApplicationRoles != null)
                  {
                    var first = true;
                    foreach (var applicationRole in applicationUserAdminDto.ApplicationRoles)
                    {
                      if (first)
                      {
                        first = false;
                      }
                      else
                      {
                        <span>, </span>
                      }
                      <span>@applicationRole.Name</span>
                    }
                  }
                </td>
                <td>@applicationUserAdminDto.Email</td>
                <td>@applicationUserAdminDto.Id</td>
                <td>@applicationUserAdminDto.PhoneNumber</td>
                <td>@applicationUserAdminDto.UserName</td>
                <td>
                  <a href="@("/admin/application-user-edit/" + applicationUserAdminDto?.Id)">Edit</a>
                </td>
              }
            </tr>
          }
        }
      </tbody>
    </table>
    <a href="/admin/application-user-edit">Create</a>
  </article>
</section>

@code {
  List<ApplicationUserAdminDto>? applicationUserAdminDtos;

  protected override async Task OnInitializedAsync()
  {
    var authState = await GetAuthenticationStateAsync.GetAuthenticationStateAsync();
    var userName = authState.User.Identity?.Name;

    if (userName == null)
    {
      return;
    }

    applicationUserAdminDtos = await ApplicationUserAdminRepository.GetAllAsync(userName);
  }
}
